#!/usr/bin/env node

/**
 * üß™ TESTE SISTEMA COMPLETO DE RESPOSTAS
 * 
 * Este script testa o sistema completo de:
 * 1. Envio de notifica√ß√µes individuais
 * 2. Coleta de respostas
 * 3. Atualiza√ß√£o da tabela de confirma√ß√£o
 * 4. Envio da lista no grupo
 */

const { createClient } = require('@supabase/supabase-js');
const moment = require('moment');
moment.locale('pt-br');

class TesteSistemaCompleto {
    constructor() {
        // Configurar Supabase com as MESMAS configura√ß√µes do Flutter
        const supabaseUrl = 'https://ddlxamlaoumhbbrnmasj.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkbHhhbWxhb3VtaGJicm5tYXNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NDAwMzcsImV4cCI6MjA3MjUxNjAzN30.VrTmCTDl0zkzP1GQ8YHAqFLbtCUlaYIp7v_4rUHbSMo';

        this.supabase = createClient(supabaseUrl, supabaseAnonKey);
    }

    async executarTeste() {
        try {
            console.log('üß™ ===== TESTE SISTEMA COMPLETO DE RESPOSTAS =====\n');
            
            // 1. Verificar estrutura do banco
            await this.verificarEstruturaBanco();
            
            // 2. Criar sess√£o de teste
            const sessaoTeste = await this.criarSessaoTeste();
            
            if (!sessaoTeste) {
                console.log('‚ùå Erro ao criar sess√£o de teste');
                return;
            }
            
            // 3. Criar configura√ß√£o de teste
            const configTeste = await this.criarConfiguracaoTeste(sessaoTeste);
            
            if (!configTeste) {
                console.log('‚ùå Erro ao criar configura√ß√£o de teste');
                return;
            }
            
            // 4. Simular confirma√ß√µes pendentes
            await this.simularConfirmacoesPendentes(sessaoTeste);
            
            // 5. Simular respostas dos jogadores
            await this.simularRespostasJogadores(sessaoTeste);
            
            // 6. Simular envio da lista no grupo
            await this.simularEnvioListaGrupo(sessaoTeste);
            
            // 7. Mostrar instru√ß√µes para teste real
            await this.mostrarInstrucoesTesteReal();
            
            // 8. Limpar dados de teste
            await this.limparDadosTeste(sessaoTeste, configTeste);
            
            console.log('\nüß™ ===== TESTE CONCLU√çDO =====\n');
            
        } catch (error) {
            console.error('‚ùå Erro durante o teste:', error);
        }
    }

    /**
     * 1. Verificar estrutura do banco
     */
    async verificarEstruturaBanco() {
        try {
            console.log('üîç 1. VERIFICANDO ESTRUTURA DO BANCO:');
            
            // Verificar tabela participation_confirmations
            const { data: confirmations, error: confirmationsError } = await this.supabase
                .from('participation_confirmations')
                .select('*')
                .limit(1);
            
            if (confirmationsError) {
                console.log('   ‚ùå Erro ao acessar participation_confirmations:', confirmationsError.message);
            } else {
                console.log('   ‚úÖ Tabela participation_confirmations: OK');
            }
            
            // Verificar mensalistas
            const { data: mensalistas, error: mensalistasError } = await this.supabase
                .from('players')
                .select('id, name, phone_number, type')
                .eq('type', 'monthly')
                .eq('status', 'active');
            
            if (mensalistasError) {
                console.log('   ‚ùå Erro ao buscar mensalistas:', mensalistasError.message);
            } else {
                console.log(`   ‚úÖ Mensalistas encontrados: ${mensalistas?.length || 0}`);
                if (mensalistas && mensalistas.length > 0) {
                    mensalistas.forEach((mensalista, index) => {
                        console.log(`      ${index + 1}. ${mensalista.name} - ${mensalista.phone_number}`);
                    });
                }
            }
            
            // Verificar jogos
            const { data: jogos, error: jogosError } = await this.supabase
                .from('games')
                .select('id, organization_name, whatsapp_group_id');
            
            if (jogosError) {
                console.log('   ‚ùå Erro ao buscar jogos:', jogosError.message);
            } else {
                console.log(`   ‚úÖ Jogos encontrados: ${jogos?.length || 0}`);
                if (jogos && jogos.length > 0) {
                    jogos.forEach((jogo, index) => {
                        console.log(`      ${index + 1}. ${jogo.organization_name} - Grupo: ${jogo.whatsapp_group_id || 'N√£o configurado'}`);
                    });
                }
            }
            
        } catch (error) {
            console.error('   ‚ùå Erro ao verificar estrutura do banco:', error);
        }
    }

    /**
     * 2. Criar sess√£o de teste
     */
    async criarSessaoTeste() {
        try {
            console.log('\nüîß 2. CRIANDO SESS√ÉO DE TESTE:');
            
            // Buscar um jogo existente
            const { data: jogos, error: jogoError } = await this.supabase
                .from('games')
                .select('id, organization_name')
                .limit(1);
            
            if (jogoError || !jogos || jogos.length === 0) {
                console.log('   ‚ùå Erro ao buscar jogo:', jogoError?.message);
                return null;
            }
            
            const jogo = jogos[0];
            const agora = moment();
            const dataSessao = agora.clone().add(30, 'minutes'); // 30 minutos no futuro
            
            const sessaoData = {
                game_id: jogo.id,
                session_date: dataSessao.format('YYYY-MM-DD'),
                start_time: dataSessao.format('HH:mm:ss'),
                end_time: dataSessao.clone().add(2, 'hours').format('HH:mm:ss'),
                status: 'scheduled',
                attendance_count: 0,
                notes: 'Sess√£o para teste do sistema completo de respostas'
            };
            
            const { data: sessao, error } = await this.supabase
                .from('game_sessions')
                .insert(sessaoData)
                .select()
                .single();
            
            if (error) {
                console.log('   ‚ùå Erro ao criar sess√£o:', error.message);
                return null;
            }
            
            console.log(`   ‚úÖ Sess√£o criada: ${sessao.id}`);
            console.log(`   üìÖ Data: ${sessao.session_date} ${sessao.start_time}`);
            console.log(`   ‚è∞ Faltam: ${dataSessao.diff(agora, 'minutes', true).toFixed(1)} minutos`);
            
            return sessao;
            
        } catch (error) {
            console.error('   ‚ùå Erro ao criar sess√£o:', error);
            return null;
        }
    }

    /**
     * 3. Criar configura√ß√£o de teste
     */
    async criarConfiguracaoTeste(sessao) {
        try {
            console.log('\nüîß 3. CRIANDO CONFIGURA√á√ÉO DE TESTE:');
            
            const configData = {
                session_id: sessao.id,
                game_id: sessao.game_id,
                total_notifications: 3,
                mensal_notifications: 2,
                notification_type: 'individual',
                whatsapp_group_id: '120363123456789012@g.us', // ID de grupo de teste
                notification_schedule: [
                    {
                        "number": 1,
                        "hours_before": 0.5, // 30 minutos antes
                        "target": "mensalistas",
                        "message_type": "confirmation"
                    },
                    {
                        "number": 2,
                        "hours_before": 0.25, // 15 minutos antes
                        "target": "mensalistas",
                        "message_type": "reminder"
                    },
                    {
                        "number": 3,
                        "hours_before": 0.1, // 6 minutos antes
                        "target": "mensalistas",
                        "message_type": "final_confirmation"
                    }
                ],
                is_active: true
            };
            
            const { data: config, error } = await this.supabase
                .from('notification_configs')
                .insert(configData)
                .select()
                .single();
            
            if (error) {
                console.log('   ‚ùå Erro ao criar configura√ß√£o:', error.message);
                return null;
            }
            
            console.log(`   ‚úÖ Configura√ß√£o criada: ${config.id}`);
            console.log(`   üîî 3 notifica√ß√µes configuradas:`);
            console.log(`      1. 30 minutos antes (mensalistas) - confirma√ß√£o`);
            console.log(`      2. 15 minutos antes (mensalistas) - lembrete`);
            console.log(`      3. 6 minutos antes (mensalistas) - confirma√ß√£o final`);
            console.log(`   üì± Grupo WhatsApp: ${config.whatsapp_group_id}`);
            
            return config;
            
        } catch (error) {
            console.error('   ‚ùå Erro ao criar configura√ß√£o:', error);
            return null;
        }
    }

    /**
     * 4. Simular confirma√ß√µes pendentes
     */
    async simularConfirmacoesPendentes(sessao) {
        try {
            console.log('\nüìù 4. SIMULANDO CONFIRMA√á√ïES PENDENTES:');
            
            // Buscar mensalistas do jogo
            const { data: mensalistas, error } = await this.supabase
                .from('game_players')
                .select(`
                    player_id,
                    players!inner(
                        id,
                        name,
                        phone_number,
                        type,
                        status
                    )
                `)
                .eq('game_id', sessao.game_id)
                .eq('status', 'active')
                .eq('players.type', 'monthly')
                .eq('players.status', 'active');
            
            if (error) {
                console.log('   ‚ùå Erro ao buscar mensalistas:', error.message);
                return;
            }
            
            if (!mensalistas || mensalistas.length === 0) {
                console.log('   üìù Nenhum mensalista encontrado para este jogo');
                return;
            }
            
            console.log(`   üìä Criando confirma√ß√µes pendentes para ${mensalistas.length} mensalistas:`);
            
            for (const mensalista of mensalistas) {
                const { players } = mensalista;
                
                // Verificar se j√° existe confirma√ß√£o
                const { data: existingConfirmation, error: checkError } = await this.supabase
                    .from('participation_confirmations')
                    .select('id')
                    .eq('session_id', sessao.id)
                    .eq('player_phone', players.phone_number)
                    .single();
                
                if (existingConfirmation) {
                    console.log(`   ‚ö†Ô∏è Confirma√ß√£o j√° existe para ${players.name}`);
                    continue;
                }
                
                // Criar confirma√ß√£o pendente
                const { data: confirmation, error: insertError } = await this.supabase
                    .from('participation_confirmations')
                    .insert({
                        session_id: sessao.id,
                        player_id: players.id,
                        player_phone: players.phone_number,
                        status: 'pending',
                        player_type: players.type,
                        notes: 'Aguardando confirma√ß√£o via WhatsApp'
                    })
                    .select()
                    .single();
                
                if (insertError) {
                    console.log(`   ‚ùå Erro ao criar confirma√ß√£o para ${players.name}:`, insertError.message);
                } else {
                    console.log(`   ‚úÖ Confirma√ß√£o pendente criada para ${players.name} (${players.phone_number})`);
                }
            }
            
        } catch (error) {
            console.error('   ‚ùå Erro ao simular confirma√ß√µes pendentes:', error);
        }
    }

    /**
     * 5. Simular respostas dos jogadores
     */
    async simularRespostasJogadores(sessao) {
        try {
            console.log('\nüì± 5. SIMULANDO RESPOSTAS DOS JOGADORES:');
            
            // Buscar confirma√ß√µes pendentes
            const { data: confirmations, error } = await this.supabase
                .from('participation_confirmations')
                .select(`
                    id,
                    player_phone,
                    players!inner(
                        name,
                        phone_number
                    )
                `)
                .eq('session_id', sessao.id)
                .eq('status', 'pending');
            
            if (error) {
                console.log('   ‚ùå Erro ao buscar confirma√ß√µes pendentes:', error.message);
                return;
            }
            
            if (!confirmations || confirmations.length === 0) {
                console.log('   üìù Nenhuma confirma√ß√£o pendente encontrada');
                return;
            }
            
            console.log(`   üìä Simulando respostas para ${confirmations.length} confirma√ß√µes:`);
            
            // Simular respostas (50% confirmam, 30% declinam, 20% n√£o respondem)
            for (let i = 0; i < confirmations.length; i++) {
                const confirmation = confirmations[i];
                const { players } = confirmation;
                
                let response;
                let responseText;
                
                if (i < Math.floor(confirmations.length * 0.5)) {
                    // 50% confirmam
                    response = 'confirmed';
                    responseText = 'SIM';
                } else if (i < Math.floor(confirmations.length * 0.8)) {
                    // 30% declinam
                    response = 'declined';
                    responseText = 'N√ÉO';
                } else {
                    // 20% n√£o respondem (permanecem pendentes)
                    console.log(`   ‚è≥ ${players.name}: N√£o respondeu (permanece pendente)`);
                    continue;
                }
                
                // Atualizar confirma√ß√£o
                const updateData = {
                    status: response,
                    updated_at: new Date().toISOString()
                };
                
                if (response === 'confirmed') {
                    updateData.confirmed_at = new Date().toISOString();
                } else if (response === 'declined') {
                    updateData.declined_at = new Date().toISOString();
                }
                
                const { error: updateError } = await this.supabase
                    .from('participation_confirmations')
                    .update(updateData)
                    .eq('id', confirmation.id);
                
                if (updateError) {
                    console.log(`   ‚ùå Erro ao atualizar confirma√ß√£o para ${players.name}:`, updateError.message);
                } else {
                    console.log(`   ‚úÖ ${players.name}: Respondeu "${responseText}" (${response})`);
                }
            }
            
        } catch (error) {
            console.error('   ‚ùå Erro ao simular respostas dos jogadores:', error);
        }
    }

    /**
     * 6. Simular envio da lista no grupo
     */
    async simularEnvioListaGrupo(sessao) {
        try {
            console.log('\nüìã 6. SIMULANDO ENVIO DA LISTA NO GRUPO:');
            
            // Buscar todas as confirma√ß√µes da sess√£o
            const { data: confirmations, error } = await this.supabase
                .from('participation_confirmations')
                .select(`
                    id,
                    status,
                    confirmed_at,
                    declined_at,
                    players!inner(
                        name,
                        phone_number
                    )
                `)
                .eq('session_id', sessao.id)
                .order('confirmed_at', { ascending: true });
            
            if (error) {
                console.log('   ‚ùå Erro ao buscar confirma√ß√µes:', error.message);
                return;
            }
            
            if (!confirmations || confirmations.length === 0) {
                console.log('   üìù Nenhuma confirma√ß√£o encontrada para esta sess√£o');
                return;
            }
            
            // Separar confirma√ß√µes por status
            const confirmed = confirmations.filter(c => c.status === 'confirmed');
            const declined = confirmations.filter(c => c.status === 'declined');
            const pending = confirmations.filter(c => c.status === 'pending');
            
            console.log(`   üìä Confirma√ß√µes encontradas:`);
            console.log(`      ‚úÖ Confirmados: ${confirmed.length}`);
            console.log(`      ‚ùå Ausentes: ${declined.length}`);
            console.log(`      ‚è≥ Pendentes: ${pending.length}`);
            console.log(`      üì± Total: ${confirmations.length}`);
            
            // Gerar mensagem da lista
            const listMessage = this.generateConfirmationListMessage(confirmed, declined, pending);
            
            console.log(`\n   üì± MENSAGEM QUE SERIA ENVIADA NO GRUPO:`);
            console.log(`   ${listMessage}`);
            
            // Simular envio no grupo
            console.log(`\n   ‚úÖ Lista seria enviada no grupo: 120363123456789012@g.us`);
            
        } catch (error) {
            console.error('   ‚ùå Erro ao simular envio da lista no grupo:', error);
        }
    }

    /**
     * Gerar mensagem da lista de confirma√ß√µes
     */
    generateConfirmationListMessage(confirmed, declined, pending) {
        let message = `üèà *LISTA DE CONFIRMA√á√ïES*\n\n`;
        
        // Confirmados
        if (confirmed.length > 0) {
            message += `‚úÖ *CONFIRMADOS (${confirmed.length}):*\n`;
            confirmed.forEach((conf, index) => {
                message += `${index + 1}. ${conf.players.name}\n`;
            });
            message += `\n`;
        }
        
        // Ausentes
        if (declined.length > 0) {
            message += `‚ùå *AUSENTES (${declined.length}):*\n`;
            declined.forEach((conf, index) => {
                message += `${index + 1}. ${conf.players.name}\n`;
            });
            message += `\n`;
        }
        
        // Pendentes
        if (pending.length > 0) {
            message += `‚è≥ *PENDENTES (${pending.length}):*\n`;
            pending.forEach((conf, index) => {
                message += `${index + 1}. ${conf.players.name}\n`;
            });
            message += `\n`;
        }
        
        message += `üìä *RESUMO:*\n`;
        message += `‚úÖ Confirmados: ${confirmed.length}\n`;
        message += `‚ùå Ausentes: ${declined.length}\n`;
        message += `‚è≥ Pendentes: ${pending.length}\n`;
        message += `üì± Total: ${confirmed.length + declined.length + pending.length}\n\n`;
        message += `üîî Lista atualizada automaticamente pelo sistema VaiDarJogo`;
        
        return message;
    }

    /**
     * 7. Mostrar instru√ß√µes para teste real
     */
    async mostrarInstrucoesTesteReal() {
        try {
            console.log('\nüìã 7. INSTRU√á√ïES PARA TESTE REAL:');
            
            console.log('   üöÄ PASSO 1: Iniciar o motor completo');
            console.log('   üìù Execute: node motor_completo_respostas.js');
            console.log('   üìù Aguarde o QR Code aparecer');
            console.log('   üìù Escaneie com o WhatsApp no seu celular');
            
            console.log('\n   üì± PASSO 2: Verificar conex√£o');
            console.log('   üìù Aguarde a mensagem "WhatsApp conectado e pronto!"');
            console.log('   üìù O motor come√ßar√° a verificar notifica√ß√µes a cada 10 segundos');
            console.log('   üìù O motor come√ßar√° a coletar respostas a cada 5 segundos');
            
            console.log('\n   ‚è∞ PASSO 3: Aguardar notifica√ß√£o');
            console.log('   üìù O motor verificar√° se √© hora de enviar notifica√ß√µes');
            console.log('   üìù Quando chegar o hor√°rio, enviar√° para cada mensalista');
            console.log('   üìù Verifique se as mensagens chegaram nos telefones');
            
            console.log('\n   üì• PASSO 4: Responder √†s notifica√ß√µes');
            console.log('   üìù Os mensalistas devem responder com SIM ou N√ÉO');
            console.log('   üìù O motor coletar√° as respostas automaticamente');
            console.log('   üìù As confirma√ß√µes ser√£o atualizadas no banco de dados');
            
            console.log('\n   üìã PASSO 5: Lista no grupo');
            console.log('   üìù 1 hora antes do jogo, o motor enviar√° a lista no grupo');
            console.log('   üìù A lista mostrar√° confirmados, ausentes e pendentes');
            console.log('   üìù Verifique se a mensagem chegou no grupo');
            
            console.log('\n   üîß FUNCIONAMENTO COMPLETO:');
            console.log('   üìù 1. Motor envia notifica√ß√µes individuais para mensalistas');
            console.log('   üìù 2. Mensalistas respondem com SIM/N√ÉO');
            console.log('   üìù 3. Motor coleta respostas e atualiza banco de dados');
            console.log('   üìù 4. Motor envia lista consolidada no grupo do jogo');
            console.log('   üìù 5. Sistema funciona automaticamente sem interven√ß√£o');
            
        } catch (error) {
            console.error('   ‚ùå Erro ao mostrar instru√ß√µes:', error);
        }
    }

    /**
     * 8. Limpar dados de teste
     */
    async limparDadosTeste(sessao, config) {
        try {
            console.log('\nüßπ 8. LIMPANDO DADOS DE TESTE:');
            
            // Remover confirma√ß√µes de teste
            const { error: confirmationsError } = await this.supabase
                .from('participation_confirmations')
                .delete()
                .eq('session_id', sessao.id);
            
            if (confirmationsError) {
                console.log('   ‚ùå Erro ao remover confirma√ß√µes:', confirmationsError.message);
            } else {
                console.log('   ‚úÖ Confirma√ß√µes removidas');
            }
            
            // Remover configura√ß√£o
            const { error: configError } = await this.supabase
                .from('notification_configs')
                .delete()
                .eq('id', config.id);
            
            if (configError) {
                console.log('   ‚ùå Erro ao remover configura√ß√£o:', configError.message);
            } else {
                console.log('   ‚úÖ Configura√ß√£o removida');
            }
            
            // Remover sess√£o
            const { error: sessaoError } = await this.supabase
                .from('game_sessions')
                .delete()
                .eq('id', sessao.id);
            
            if (sessaoError) {
                console.log('   ‚ùå Erro ao remover sess√£o:', sessaoError.message);
            } else {
                console.log('   ‚úÖ Sess√£o removida');
            }
            
            console.log('   üìù Dados de teste removidos');
            console.log('   üìù Sistema limpo para uso normal');
            
        } catch (error) {
            console.error('   ‚ùå Erro ao limpar dados:', error);
        }
    }
}

// Executar teste
async function main() {
    const teste = new TesteSistemaCompleto();
    await teste.executarTeste();
}

// Executar se este arquivo for chamado diretamente
if (require.main === module) {
    main().catch(console.error);
}

module.exports = TesteSistemaCompleto;

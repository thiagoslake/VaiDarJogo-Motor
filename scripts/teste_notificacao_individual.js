#!/usr/bin/env node

/**
 * üì± TESTE NOTIFICA√á√ÉO INDIVIDUAL
 * 
 * Este script testa o envio de notifica√ß√µes individuais
 * para mensalistas usando seus n√∫meros de telefone.
 */

const { createClient } = require('@supabase/supabase-js');
const moment = require('moment');
moment.locale('pt-br');

class TesteNotificacaoIndividual {
    constructor() {
        // Configurar Supabase com as MESMAS configura√ß√µes do Flutter
        const supabaseUrl = 'https://ddlxamlaoumhbbrnmasj.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkbHhhbWxhb3VtaGJicm5tYXNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NDAwMzcsImV4cCI6MjA3MjUxNjAzN30.VrTmCTDl0zkzP1GQ8YHAqFLbtCUlaYIp7v_4rUHbSMo';

        this.supabase = createClient(supabaseUrl, supabaseAnonKey);
    }

    async executarTeste() {
        try {
            console.log('üì± ===== TESTE NOTIFICA√á√ÉO INDIVIDUAL =====\n');
            
            // 1. Verificar mensalistas cadastrados
            await this.verificarMensalistas();
            
            // 2. Criar sess√£o de teste
            const sessaoTeste = await this.criarSessaoTeste();
            
            if (!sessaoTeste) {
                console.log('‚ùå Erro ao criar sess√£o de teste');
                return;
            }
            
            // 3. Criar configura√ß√£o de teste
            const configTeste = await this.criarConfiguracaoTeste(sessaoTeste);
            
            if (!configTeste) {
                console.log('‚ùå Erro ao criar configura√ß√£o de teste');
                return;
            }
            
            // 4. Simular notifica√ß√µes individuais
            await this.simularNotificacoesIndividuais(sessaoTeste);
            
            // 5. Mostrar instru√ß√µes para teste real
            await this.mostrarInstrucoesTesteReal();
            
            // 6. Limpar dados de teste
            await this.limparDadosTeste(sessaoTeste, configTeste);
            
            console.log('\nüì± ===== TESTE CONCLU√çDO =====\n');
            
        } catch (error) {
            console.error('‚ùå Erro durante o teste:', error);
        }
    }

    /**
     * 1. Verificar mensalistas cadastrados
     */
    async verificarMensalistas() {
        try {
            console.log('üîç 1. VERIFICANDO MENSALISTAS CADASTRADOS:');
            
            // Buscar todos os mensalistas
            const { data: mensalistas, error } = await this.supabase
                .from('players')
                .select('id, name, phone_number, type, status')
                .eq('type', 'monthly')
                .eq('status', 'active');
            
            if (error) {
                console.log('   ‚ùå Erro ao buscar mensalistas:', error.message);
                return;
            }
            
            if (!mensalistas || mensalistas.length === 0) {
                console.log('   üìù Nenhum mensalista cadastrado');
                return;
            }
            
            console.log(`   üìä Encontrados ${mensalistas.length} mensalistas:`);
            mensalistas.forEach((mensalista, index) => {
                console.log(`   ${index + 1}. ${mensalista.name} - ${mensalista.phone_number}`);
            });
            
            // Verificar mensalistas por jogo
            console.log('\n   üéÆ Mensalistas por jogo:');
            const { data: jogos, error: jogosError } = await this.supabase
                .from('games')
                .select('id, organization_name');
            
            if (jogosError) {
                console.log('   ‚ùå Erro ao buscar jogos:', jogosError.message);
                return;
            }
            
            for (const jogo of jogos || []) {
                const { data: mensalistasJogo, error: mensalistasError } = await this.supabase
                    .from('game_players')
                    .select(`
                        player_id,
                        players!inner(
                            name,
                            phone_number,
                            type
                        )
                    `)
                    .eq('game_id', jogo.id)
                    .eq('status', 'active')
                    .eq('players.type', 'monthly');
                
                if (mensalistasError) {
                    console.log(`   ‚ùå Erro ao buscar mensalistas do jogo ${jogo.organization_name}:`, mensalistasError.message);
                    continue;
                }
                
                console.log(`   üèà ${jogo.organization_name}: ${mensalistasJogo?.length || 0} mensalistas`);
                if (mensalistasJogo && mensalistasJogo.length > 0) {
                    mensalistasJogo.forEach((mensalista, index) => {
                        console.log(`      ${index + 1}. ${mensalista.players.name} - ${mensalista.players.phone_number}`);
                    });
                }
            }
            
        } catch (error) {
            console.error('   ‚ùå Erro ao verificar mensalistas:', error);
        }
    }

    /**
     * 2. Criar sess√£o de teste
     */
    async criarSessaoTeste() {
        try {
            console.log('\nüîß 2. CRIANDO SESS√ÉO DE TESTE:');
            
            // Buscar um jogo existente
            const { data: jogos, error: jogoError } = await this.supabase
                .from('games')
                .select('id, organization_name')
                .limit(1);
            
            if (jogoError || !jogos || jogos.length === 0) {
                console.log('   ‚ùå Erro ao buscar jogo:', jogoError?.message);
                return null;
            }
            
            const jogo = jogos[0];
            const agora = moment();
            const dataSessao = agora.clone().add(20, 'minutes'); // 20 minutos no futuro
            
            const sessaoData = {
                game_id: jogo.id,
                session_date: dataSessao.format('YYYY-MM-DD'),
                start_time: dataSessao.format('HH:mm:ss'),
                end_time: dataSessao.clone().add(2, 'hours').format('HH:mm:ss'),
                status: 'scheduled',
                attendance_count: 0,
                notes: 'Sess√£o para teste de notifica√ß√µes individuais'
            };
            
            const { data: sessao, error } = await this.supabase
                .from('game_sessions')
                .insert(sessaoData)
                .select()
                .single();
            
            if (error) {
                console.log('   ‚ùå Erro ao criar sess√£o:', error.message);
                return null;
            }
            
            console.log(`   ‚úÖ Sess√£o criada: ${sessao.id}`);
            console.log(`   üìÖ Data: ${sessao.session_date} ${sessao.start_time}`);
            console.log(`   ‚è∞ Faltam: ${dataSessao.diff(agora, 'minutes', true).toFixed(1)} minutos`);
            
            return sessao;
            
        } catch (error) {
            console.error('   ‚ùå Erro ao criar sess√£o:', error);
            return null;
        }
    }

    /**
     * 3. Criar configura√ß√£o de teste
     */
    async criarConfiguracaoTeste(sessao) {
        try {
            console.log('\nüîß 3. CRIANDO CONFIGURA√á√ÉO DE TESTE:');
            
            const configData = {
                session_id: sessao.id,
                game_id: sessao.game_id,
                total_notifications: 3,
                mensal_notifications: 2,
                notification_type: 'individual', // Mudado para individual
                whatsapp_group_id: null, // N√£o usado para notifica√ß√µes individuais
                notification_schedule: [
                    {
                        "number": 1,
                        "hours_before": 0.3, // 18 minutos antes
                        "target": "mensalistas",
                        "message_type": "confirmation"
                    },
                    {
                        "number": 2,
                        "hours_before": 0.2, // 12 minutos antes
                        "target": "mensalistas",
                        "message_type": "reminder"
                    },
                    {
                        "number": 3,
                        "hours_before": 0.1, // 6 minutos antes
                        "target": "mensalistas",
                        "message_type": "final_confirmation"
                    }
                ],
                is_active: true
            };
            
            const { data: config, error } = await this.supabase
                .from('notification_configs')
                .insert(configData)
                .select()
                .single();
            
            if (error) {
                console.log('   ‚ùå Erro ao criar configura√ß√£o:', error.message);
                return null;
            }
            
            console.log(`   ‚úÖ Configura√ß√£o criada: ${config.id}`);
            console.log(`   üîî 3 notifica√ß√µes configuradas:`);
            console.log(`      1. 18 minutos antes (mensalistas) - confirma√ß√£o`);
            console.log(`      2. 12 minutos antes (mensalistas) - lembrete`);
            console.log(`      3. 6 minutos antes (mensalistas) - confirma√ß√£o final`);
            console.log(`   üì± Tipo: Individual (n√£o usa grupo)`);
            
            return config;
            
        } catch (error) {
            console.error('   ‚ùå Erro ao criar configura√ß√£o:', error);
            return null;
        }
    }

    /**
     * 4. Simular notifica√ß√µes individuais
     */
    async simularNotificacoesIndividuais(sessao) {
        try {
            console.log('\nüì§ 4. SIMULANDO NOTIFICA√á√ïES INDIVIDUAIS:');
            
            // Buscar mensalistas do jogo
            const { data: mensalistas, error } = await this.supabase
                .from('game_players')
                .select(`
                    player_id,
                    players!inner(
                        id,
                        name,
                        phone_number,
                        type,
                        status
                    )
                `)
                .eq('game_id', sessao.game_id)
                .eq('status', 'active')
                .eq('players.type', 'monthly')
                .eq('players.status', 'active');
            
            if (error) {
                console.log('   ‚ùå Erro ao buscar mensalistas:', error.message);
                return;
            }
            
            if (!mensalistas || mensalistas.length === 0) {
                console.log('   üìù Nenhum mensalista encontrado para este jogo');
                return;
            }
            
            console.log(`   üìä Encontrados ${mensalistas.length} mensalistas para notificar:`);
            
            const agora = moment();
            const dataSessao = moment(`${sessao.session_date} ${sessao.start_time}`, 'YYYY-MM-DD HH:mm:ss');
            const formattedDate = dataSessao.format('DD/MM/YYYY [√†s] HH:mm');
            
            for (const mensalista of mensalistas) {
                const { players } = mensalista;
                
                console.log(`\n   üë§ ${players.name}:`);
                console.log(`      üì± Telefone: ${players.phone_number}`);
                
                // Formatar n√∫mero para WhatsApp
                const phoneFormatted = this.formatPhoneForWhatsApp(players.phone_number);
                console.log(`      üì± WhatsApp: ${phoneFormatted}`);
                
                // Gerar mensagem
                const message = this.generateIndividualMessage(players.name, 'Jogo de Teste', formattedDate, 'Local de Teste');
                console.log(`      üì± Mensagem:`);
                console.log(`      ${message}`);
                
                // Simular envio
                console.log(`      ‚úÖ Notifica√ß√£o seria enviada para ${phoneFormatted}`);
            }
            
        } catch (error) {
            console.error('   ‚ùå Erro ao simular notifica√ß√µes:', error);
        }
    }

    /**
     * Formatar n√∫mero de telefone para WhatsApp
     */
    formatPhoneForWhatsApp(phoneNumber) {
        try {
            // Remover caracteres n√£o num√©ricos
            let cleanNumber = phoneNumber.replace(/\D/g, '');
            
            // Se come√ßar com 55 (Brasil), manter
            if (cleanNumber.startsWith('55')) {
                return cleanNumber + '@c.us';
            }
            
            // Se come√ßar com 0, remover
            if (cleanNumber.startsWith('0')) {
                cleanNumber = cleanNumber.substring(1);
            }
            
            // Adicionar c√≥digo do Brasil se n√£o tiver
            if (!cleanNumber.startsWith('55')) {
                cleanNumber = '55' + cleanNumber;
            }
            
            return cleanNumber + '@c.us';
            
        } catch (error) {
            console.error('‚ùå Erro ao formatar n√∫mero:', error);
            return null;
        }
    }

    /**
     * Gerar mensagem individual personalizada
     */
    generateIndividualMessage(playerName, gameName, formattedDate, location) {
        const message = `üèà *Ol√° ${playerName}!*\n\n` +
                       `üìÖ *Jogo: ${gameName}*\n` +
                       `üìÖ Data: ${formattedDate}\n` +
                       `üìç Local: ${location}\n\n` +
                       `‚öΩ *Confirme sua presen√ßa no jogo!*\n\n` +
                       `üì± Responda:\n` +
                       `‚úÖ SIM - para confirmar presen√ßa\n` +
                       `‚ùå N√ÉO - para informar aus√™ncia\n\n` +
                       `üîî Esta √© uma notifica√ß√£o autom√°tica do sistema VaiDarJogo.`;
        
        return message;
    }

    /**
     * 5. Mostrar instru√ß√µes para teste real
     */
    async mostrarInstrucoesTesteReal() {
        try {
            console.log('\nüìã 5. INSTRU√á√ïES PARA TESTE REAL:');
            
            console.log('   üöÄ PASSO 1: Iniciar o motor individual');
            console.log('   üìù Execute: node motor_corrigido_individual.js');
            console.log('   üìù Aguarde o QR Code aparecer');
            console.log('   üìù Escaneie com o WhatsApp no seu celular');
            
            console.log('\n   üì± PASSO 2: Verificar conex√£o');
            console.log('   üìù Aguarde a mensagem "WhatsApp conectado e pronto!"');
            console.log('   üìù O motor come√ßar√° a verificar notifica√ß√µes a cada 10 segundos');
            
            console.log('\n   ‚è∞ PASSO 3: Aguardar notifica√ß√£o');
            console.log('   üìù O motor verificar√° se √© hora de enviar notifica√ß√µes');
            console.log('   üìù Quando chegar o hor√°rio, enviar√° para cada mensalista');
            console.log('   üìù Verifique se as mensagens chegaram nos telefones');
            
            console.log('\n   üìä PASSO 4: Verificar estat√≠sticas');
            console.log('   üìù Execute: node comando_stats.js');
            console.log('   üìù Verifique se as notifica√ß√µes foram registradas');
            
            console.log('\n   üîß FUNCIONAMENTO:');
            console.log('   üìù O motor busca mensalistas ativos do jogo');
            console.log('   üìù Formata os n√∫meros de telefone para WhatsApp');
            console.log('   üìù Envia mensagem individual para cada mensalista');
            console.log('   üìù Salva log de cada notifica√ß√£o enviada');
            
        } catch (error) {
            console.error('   ‚ùå Erro ao mostrar instru√ß√µes:', error);
        }
    }

    /**
     * 6. Limpar dados de teste
     */
    async limparDadosTeste(sessao, config) {
        try {
            console.log('\nüßπ 6. LIMPANDO DADOS DE TESTE:');
            
            // Remover configura√ß√£o
            const { error: configError } = await this.supabase
                .from('notification_configs')
                .delete()
                .eq('id', config.id);
            
            if (configError) {
                console.log('   ‚ùå Erro ao remover configura√ß√£o:', configError.message);
            } else {
                console.log('   ‚úÖ Configura√ß√£o removida');
            }
            
            // Remover sess√£o
            const { error: sessaoError } = await this.supabase
                .from('game_sessions')
                .delete()
                .eq('id', sessao.id);
            
            if (sessaoError) {
                console.log('   ‚ùå Erro ao remover sess√£o:', sessaoError.message);
            } else {
                console.log('   ‚úÖ Sess√£o removida');
            }
            
            console.log('   üìù Dados de teste removidos');
            console.log('   üìù Sistema limpo para uso normal');
            
        } catch (error) {
            console.error('   ‚ùå Erro ao limpar dados:', error);
        }
    }
}

// Executar teste
async function main() {
    const teste = new TesteNotificacaoIndividual();
    await teste.executarTeste();
}

// Executar se este arquivo for chamado diretamente
if (require.main === module) {
    main().catch(console.error);
}

module.exports = TesteNotificacaoIndividual;

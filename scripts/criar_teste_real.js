#!/usr/bin/env node

/**
 * üß™ CRIAR TESTE REAL
 * 
 * Este script cria uma sess√£o de teste com hor√°rio pr√≥ximo
 * para testar o sistema completo de respostas em tempo real.
 */

const { createClient } = require('@supabase/supabase-js');
const moment = require('moment');
moment.locale('pt-br');

class CriarTesteReal {
    constructor() {
        // Configurar Supabase com as MESMAS configura√ß√µes do Flutter
        const supabaseUrl = 'https://ddlxamlaoumhbbrnmasj.supabase.co';
        const supabaseAnonKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRkbHhhbWxhb3VtaGJicm5tYXNqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY5NDAwMzcsImV4cCI6MjA3MjUxNjAzN30.VrTmCTDl0zkzP1GQ8YHAqFLbtCUlaYIp7v_4rUHbSMo';

        this.supabase = createClient(supabaseUrl, supabaseAnonKey);
    }

    async criarTesteReal() {
        try {
            console.log('üß™ ===== CRIANDO TESTE REAL =====\n');
            
            // 1. Verificar mensalistas dispon√≠veis
            await this.verificarMensalistas();
            
            // 2. Criar sess√£o de teste com hor√°rio pr√≥ximo
            const sessaoTeste = await this.criarSessaoTesteReal();
            
            if (!sessaoTeste) {
                console.log('‚ùå Erro ao criar sess√£o de teste');
                return;
            }
            
            // 3. Criar configura√ß√£o de teste
            const configTeste = await this.criarConfiguracaoTesteReal(sessaoTeste);
            
            if (!configTeste) {
                console.log('‚ùå Erro ao criar configura√ß√£o de teste');
                return;
            }
            
            // 4. Mostrar instru√ß√µes para o teste
            await this.mostrarInstrucoesTeste(sessaoTeste, configTeste);
            
            console.log('\nüß™ ===== TESTE REAL CRIADO =====\n');
            
        } catch (error) {
            console.error('‚ùå Erro durante a cria√ß√£o do teste:', error);
        }
    }

    /**
     * 1. Verificar mensalistas dispon√≠veis
     */
    async verificarMensalistas() {
        try {
            console.log('üîç 1. VERIFICANDO MENSALISTAS DISPON√çVEIS:');
            
            // Buscar mensalistas
            const { data: mensalistas, error } = await this.supabase
                .from('players')
                .select('id, name, phone_number, type, status')
                .eq('type', 'monthly')
                .eq('status', 'active');
            
            if (error) {
                console.log('   ‚ùå Erro ao buscar mensalistas:', error.message);
                return;
            }
            
            if (!mensalistas || mensalistas.length === 0) {
                console.log('   üìù Nenhum mensalista encontrado');
                return;
            }
            
            console.log(`   üìä Encontrados ${mensalistas.length} mensalistas:`);
            mensalistas.forEach((mensalista, index) => {
                console.log(`   ${index + 1}. ${mensalista.name} - ${mensalista.phone_number}`);
            });
            
            // Verificar mensalistas por jogo
            console.log('\n   üéÆ Mensalistas por jogo:');
            const { data: jogos, error: jogosError } = await this.supabase
                .from('games')
                .select('id, organization_name');
            
            if (jogosError) {
                console.log('   ‚ùå Erro ao buscar jogos:', jogosError.message);
                return;
            }
            
            for (const jogo of jogos || []) {
                const { data: mensalistasJogo, error: mensalistasError } = await this.supabase
                    .from('game_players')
                    .select(`
                        player_id,
                        players!inner(
                            name,
                            phone_number,
                            type
                        )
                    `)
                    .eq('game_id', jogo.id)
                    .eq('status', 'active')
                    .eq('players.type', 'monthly');
                
                if (mensalistasError) {
                    console.log(`   ‚ùå Erro ao buscar mensalistas do jogo ${jogo.organization_name}:`, mensalistasError.message);
                    continue;
                }
                
                console.log(`   üèà ${jogo.organization_name}: ${mensalistasJogo?.length || 0} mensalistas`);
                if (mensalistasJogo && mensalistasJogo.length > 0) {
                    mensalistasJogo.forEach((mensalista, index) => {
                        console.log(`      ${index + 1}. ${mensalista.players.name} - ${mensalista.players.phone_number}`);
                    });
                }
            }
            
        } catch (error) {
            console.error('   ‚ùå Erro ao verificar mensalistas:', error);
        }
    }

    /**
     * 2. Criar sess√£o de teste com hor√°rio pr√≥ximo
     */
    async criarSessaoTesteReal() {
        try {
            console.log('\nüîß 2. CRIANDO SESS√ÉO DE TESTE REAL:');
            
            // Buscar um jogo existente
            const { data: jogos, error: jogoError } = await this.supabase
                .from('games')
                .select('id, organization_name')
                .limit(1);
            
            if (jogoError || !jogos || jogos.length === 0) {
                console.log('   ‚ùå Erro ao buscar jogo:', jogoError?.message);
                return null;
            }
            
            const jogo = jogos[0];
            const agora = moment();
            
            // Criar sess√£o para 5 minutos no futuro (para teste imediato)
            const dataSessao = agora.clone().add(5, 'minutes');
            
            const sessaoData = {
                game_id: jogo.id,
                session_date: dataSessao.format('YYYY-MM-DD'),
                start_time: dataSessao.format('HH:mm:ss'),
                end_time: dataSessao.clone().add(2, 'hours').format('HH:mm:ss'),
                status: 'scheduled',
                attendance_count: 0,
                notes: 'Sess√£o de TESTE REAL - Sistema de confirma√ß√µes autom√°ticas'
            };
            
            const { data: sessao, error } = await this.supabase
                .from('game_sessions')
                .insert(sessaoData)
                .select()
                .single();
            
            if (error) {
                console.log('   ‚ùå Erro ao criar sess√£o:', error.message);
                return null;
            }
            
            console.log(`   ‚úÖ Sess√£o criada: ${sessao.id}`);
            console.log(`   üìÖ Data: ${sessao.session_date} ${sessao.start_time}`);
            console.log(`   ‚è∞ Faltam: ${dataSessao.diff(agora, 'minutes', true).toFixed(1)} minutos`);
            console.log(`   üéÆ Jogo: ${jogo.organization_name}`);
            
            return sessao;
            
        } catch (error) {
            console.error('   ‚ùå Erro ao criar sess√£o:', error);
            return null;
        }
    }

    /**
     * 3. Criar configura√ß√£o de teste
     */
    async criarConfiguracaoTesteReal(sessao) {
        try {
            console.log('\nüîß 3. CRIANDO CONFIGURA√á√ÉO DE TESTE REAL:');
            
            const configData = {
                session_id: sessao.id,
                game_id: sessao.game_id,
                total_notifications: 3,
                mensal_notifications: 2,
                notification_type: 'individual',
                whatsapp_group_id: '120363123456789012@g.us', // ID de grupo de teste
                notification_schedule: [
                    {
                        "number": 1,
                        "hours_before": 0.08, // 5 minutos antes (para teste imediato)
                        "target": "mensalistas",
                        "message_type": "confirmation"
                    },
                    {
                        "number": 2,
                        "hours_before": 0.05, // 3 minutos antes
                        "target": "mensalistas",
                        "message_type": "reminder"
                    },
                    {
                        "number": 3,
                        "hours_before": 0.02, // 1.2 minutos antes
                        "target": "mensalistas",
                        "message_type": "final_confirmation"
                    }
                ],
                is_active: true
            };
            
            const { data: config, error } = await this.supabase
                .from('notification_configs')
                .insert(configData)
                .select()
                .single();
            
            if (error) {
                console.log('   ‚ùå Erro ao criar configura√ß√£o:', error.message);
                return null;
            }
            
            console.log(`   ‚úÖ Configura√ß√£o criada: ${config.id}`);
            console.log(`   üîî 3 notifica√ß√µes configuradas:`);
            console.log(`      1. 5 minutos antes (mensalistas) - confirma√ß√£o`);
            console.log(`      2. 3 minutos antes (mensalistas) - lembrete`);
            console.log(`      3. 1.2 minutos antes (mensalistas) - confirma√ß√£o final`);
            console.log(`   üì± Grupo WhatsApp: ${config.whatsapp_group_id}`);
            
            return config;
            
        } catch (error) {
            console.error('   ‚ùå Erro ao criar configura√ß√£o:', error);
            return null;
        }
    }

    /**
     * 4. Mostrar instru√ß√µes para o teste
     */
    async mostrarInstrucoesTeste(sessao, config) {
        try {
            console.log('\nüìã 4. INSTRU√á√ïES PARA O TESTE REAL:');
            
            console.log('   üöÄ PASSO 1: Iniciar o motor completo');
            console.log('   üìù Execute: node motor_completo_respostas.js');
            console.log('   üìù Aguarde o QR Code aparecer');
            console.log('   üìù Escaneie com o WhatsApp no seu celular');
            
            console.log('\n   üì± PASSO 2: Verificar conex√£o');
            console.log('   üìù Aguarde a mensagem "WhatsApp conectado e pronto!"');
            console.log('   üìù O motor come√ßar√° a verificar notifica√ß√µes a cada 10 segundos');
            console.log('   üìù O motor come√ßar√° a coletar respostas a cada 5 segundos');
            
            console.log('\n   ‚è∞ PASSO 3: Aguardar notifica√ß√£o (5 minutos)');
            console.log('   üìù O motor verificar√° se √© hora de enviar notifica√ß√µes');
            console.log('   üìù Quando chegar o hor√°rio, enviar√° para cada mensalista');
            console.log('   üìù Verifique se as mensagens chegaram nos telefones');
            
            console.log('\n   üì• PASSO 4: Responder √†s notifica√ß√µes');
            console.log('   üìù Os mensalistas devem responder com SIM ou N√ÉO');
            console.log('   üìù O motor coletar√° as respostas automaticamente');
            console.log('   üìù As confirma√ß√µes ser√£o atualizadas no banco de dados');
            
            console.log('\n   üìã PASSO 5: Lista no grupo (1 hora antes)');
            console.log('   üìù 1 hora antes do jogo, o motor enviar√° a lista no grupo');
            console.log('   üìù A lista mostrar√° confirmados, ausentes e pendentes');
            console.log('   üìù Verifique se a mensagem chegou no grupo');
            
            console.log('\n   üìä DADOS DO TESTE:');
            console.log(`   üéÆ Jogo: ${sessao.game_id}`);
            console.log(`   üìÖ Sess√£o: ${sessao.session_date} ${sessao.start_time}`);
            console.log(`   üîî Configura√ß√£o: ${config.id}`);
            console.log(`   üì± Grupo: ${config.whatsapp_group_id}`);
            
            console.log('\n   ‚ö†Ô∏è IMPORTANTE:');
            console.log('   üìù Este √© um TESTE REAL - as notifica√ß√µes ser√£o enviadas');
            console.log('   üìù Certifique-se de que o WhatsApp est√° conectado');
            console.log('   üìù Os mensalistas receber√£o mensagens reais');
            console.log('   üìù Ap√≥s o teste, execute o script de limpeza');
            
        } catch (error) {
            console.error('   ‚ùå Erro ao mostrar instru√ß√µes:', error);
        }
    }
}

// Executar cria√ß√£o do teste
async function main() {
    const teste = new CriarTesteReal();
    await teste.criarTesteReal();
}

// Executar se este arquivo for chamado diretamente
if (require.main === module) {
    main().catch(console.error);
}

module.exports = CriarTesteReal;
